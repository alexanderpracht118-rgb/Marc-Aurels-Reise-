import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { BookOpen, ChevronRight, ChevronLeft, MapPin, Scroll, Info, Layers, Anchor, PenTool } from 'lucide-react';

// --- DATEN: MARC AUREL (Gold/Amber) ---
const MARC_AUREL_DATA = [
  {
    id: 1,
    title: "Der Aufbruch im Norden",
    location: "Sirmium / Pannonien",
    coords: [44.97, 19.61],
    date: "175 n. Chr.",
    text: "Marc Aurel plant, das Markomannen- und Sarmatenland endg√ºltig zur Provinz zu machen. Doch die Nachricht vom Usurpationsversuch des Avidius Cassius im Osten zwingt ihn zum Abbruch. Er schlie√üt eilig Frieden mit den Jazygen.",
    quote: "So gab denn Marcus den Sarmaten- und Markomannenkrieg auf und zog gegen Cassius.",
    source: "Historia Augusta, MA 25,1"
  },
  {
    id: 2,
    title: "Marsch durch Syrien",
    location: "Syrien",
    coords: [34.80, 38.99],
    date: "Ende 175 n. Chr.",
    text: "Der Kaiser reist mit seiner Frau Faustina und Sohn Commodus in den Osten. Noch bevor sie eintreffen, wird der Usurpator Cassius von einem eigenen Centurio get√∂tet. Marc Aurel weigert sich, das Haupt des Feindes zu sehen.",
    quote: "Er hatte die Absicht [...] reiste er mit seinem Vater nach Syrien und √Ñgypten.",
    source: "Historia Augusta, C 2,3"
  },
  {
    id: 3,
    title: "Vergebung in Antiochia",
    location: "Antiochia am Orontes",
    coords: [36.20, 36.16],
    date: "176 n. Chr.",
    text: "Antiochia war das Zentrum des Aufstands. Anfangs mied Marc Aurel die Stadt und verbot √∂ffentliche Schauspiele. Sp√§ter besuchte er sie doch und zeigte Milde, indem er den Einwohnern verzieh.",
    quote: "Hinterher hat er doch noch Antiochia besucht. [...] Er verzieh auch den St√§dten.",
    source: "Historia Augusta, MA 25,8-26"
  },
  {
    id: 4,
    title: "Der Philosoph in √Ñgypten",
    location: "Alexandria",
    coords: [31.20, 29.91],
    date: "176 n. Chr.",
    text: "In Alexandria tritt der Kaiser als 'B√ºrger und Philosoph' auf. Er besucht Tempel und Lehrst√§tten. Er l√§sst die Korrespondenz des Cassius verbrennen, ohne sie zu lesen, um niemanden bestrafen zu m√ºssen.",
    quote: "Bei den √Ñgyptern gab er sich [...] als B√ºrger und Philosoph.",
    source: "Historia Augusta, MA 26,3"
  },
  {
    id: 5,
    title: "Tod der Faustina",
    location: "Halala (Faustinopolis)",
    coords: [37.35, 34.90],
    date: "176 n. Chr.",
    text: "Auf der R√ºckreise stirbt Kaiserin Faustina in einem Dorf in Kappadokien. Marc Aurel trauert tief, l√§sst sie zur G√∂ttin erheben und benennt den Ort in 'Faustinopolis' um.",
    quote: "Zur n√§mlichen Zeit schied auch Faustina aus dem Leben.",
    source: "Cassius Dio 72, 29,1"
  },
  {
    id: 6,
    title: "Einweihung in Athen",
    location: "Athen",
    coords: [37.98, 23.72],
    date: "Herbst 176 n. Chr.",
    text: "In Athen l√§sst sich Marc Aurel in die Eleusinischen Mysterien einweihen, um seine rituelle Reinheit zu beweisen. Er stiftet Lehrst√ºhle f√ºr Philosophie.",
    quote: "Nach der Regelung der Angelegenheiten im Osten hielt er sich in Athen auf.",
    source: "Historia Augusta, MA 27,1"
  },
  {
    id: 7,
    title: "R√ºckkehr als Zivilist",
    location: "Brundisium",
    coords: [40.63, 17.94],
    date: "176 n. Chr.",
    text: "Bei der Landung in Italien legt er sofort den Feldherrenmantel ab und legt die Toga an. Auch seine Soldaten m√ºssen Zivil tragen.",
    quote: "√úber Brundisium in Italien eingetroffen, legte er [...] selbst die Toga an.",
    source: "Historia Augusta, MA 27,3"
  },
  {
    id: 8,
    title: "Triumph in der Hauptstadt",
    location: "Rom",
    coords: [41.90, 12.49],
    date: "Dezember 176 n. Chr.",
    text: "Marc Aurel feiert einen Triumphzug √ºber die Germanen und Sarmaten. Commodus wird zum Mitregenten ernannt.",
    quote: "In Rom zog er in Triumph ein.",
    source: "Historia Augusta, MA 27,4"
  },
  {
    id: 9,
    title: "Pilgerfahrt zu den Urspr√ºngen",
    location: "Lavinium",
    coords: [41.66, 12.48],
    date: "176/177 n. Chr.",
    text: "Zum Abschluss reist er ins nahe Lavinium, die legend√§re Gr√ºndungsstadt des Aeneas.",
    quote: "Und reiste dort nach Lavinium.",
    source: "Historia Augusta, MA 27,4"
  }
];

// --- DATEN: PLINIUS (Cyan/Teal) ---
const PLINIUS_DATA = [
  {
    id: 1,
    title: "St√ºrmische √úberfahrt",
    location: "Kap Malea / √Ñg√§is",
    coords: [36.43, 23.20],
    date: "ca. 111 n. Chr.",
    text: "Plinius berichtet Trajan von seiner harten Seereise. Er segelt um Kap Malea und wird durch widrige Winde ('contrariis ventis') aufgehalten. Er entscheidet sich, teils mit K√ºstenschiffen, teils mit Wagen weiterzureisen.",
    quote: "Melde ich Dir, da√ü ich mit allen meinen Leuten zu Schiff an Kap Malea vorbei [...] nach Ephesus gelangt bin.",
    source: "Plinius, Epist. X, 15"
  },
  {
    id: 2,
    title: "Ankunft in Asien",
    location: "Ephesus",
    coords: [37.94, 27.34],
    date: "September",
    text: "Ankunft in der Metropole Ephesus. Von hier aus plant er die Weiterreise in seine Provinz Bithynien. Die Hitze macht ihm zu schaffen, weshalb er zwischen Schiff und Wagen wechselt.",
    quote: "Herr, wenn mir die Seereise bis Ephesus sehr gut bekommen ist...",
    source: "Plinius, Epist. X, 17a"
  },
  {
    id: 3,
    title: "Krankheit auf dem Weg",
    location: "Pergamum",
    coords: [39.12, 27.18],
    date: "September",
    text: "Die Reise im Wagen bei gro√üer Hitze verursacht Fieberanf√§lle. Plinius muss in Pergamum eine Pause einlegen. Als er auf K√ºstenschiffe umsteigt, halten ihn Gegenwinde erneut auf.",
    quote: "...habe ich, seit ich im Wagen reise, sehr unter der dr√ºckenden Hitze [...] gelitten und deshalb in Pergamum haltgemacht.",
    source: "Plinius, Epist. X, 17a"
  },
  {
    id: 4,
    title: "Ankunft in der Provinz",
    location: "Bithynien / Prusa",
    coords: [40.18, 29.06],
    date: "17. September",
    text: "Plinius trifft endlich in seiner Provinz ein und beginnt sofort in Prusa mit der Arbeit: Er pr√ºft die Finanzen der Stadt. Er entdeckt Unregelm√§√üigkeiten und fordert einen Baumeister an.",
    quote: "Zur Zeit pr√ºfe ich die Ausgaben, Einnahmen und Au√üenst√§nde in Prusa.",
    source: "Plinius, Epist. X, 17a"
  },
  {
    id: 5,
    title: "Die Bauruine",
    location: "Nicomedia",
    coords: [40.76, 29.92],
    date: "Winter 111/112 n. Chr.",
    text: "In Nicomedia inspiziert Plinius eine gescheiterte Wasserleitung, die Millionen Sesterzen verschlungen hat und dennoch unfertig ist. Er bittet Trajan dringend um einen Wasseringenieur.",
    quote: "Herr, f√ºr eine Wasserleitung haben die Nicomedenser 3.318.000 Sestertien verausgabt, aber sie ist bis jetzt unvollendet.",
    source: "Plinius, Epist. X, 37"
  },
  {
    id: 6,
    title: "Das sinkende Theater",
    location: "Nicaea",
    coords: [40.43, 29.72],
    date: "112 n. Chr.",
    text: "In Nicaea findet er ein Theater vor, das sich wegen weichen Bodens senkt und Risse bekommt, obwohl bereits 10 Millionen Sesterzen investiert wurden. Ein weiteres Beispiel f√ºr Misswirtschaft.",
    quote: "Herr, das Theater in Nicaea [...] hat [...] mehr als 10 Mill. verschlungen; ich f√ºrchte, f√ºr nichts und wieder nichts.",
    source: "Plinius, Epist. X, 39"
  },
  {
    id: 7,
    title: "Ein Bad im Sumpf",
    location: "Claudiopolis",
    coords: [40.85, 31.15], // Wahrscheinlich Bolu
    date: "112 n. Chr.",
    text: "Die Claudiopolitaner bauen ein riesiges Bad in einer Niederung, die von einem Berg √ºberragt wird. Plinius f√ºrchtet, dass auch hier √∂ffentliche Gelder verschwendet werden.",
    quote: "Auch die Claudiopolitaner bauen oder genauer gesagt graben ein gewaltiges Bad in einer Niederung.",
    source: "Plinius, Epist. X, 39"
  },
  {
    id: 8,
    title: "Rechnungspr√ºfung in Europa",
    location: "Byzanz (Byzantium)",
    coords: [41.00, 28.95],
    date: "112 n. Chr.",
    text: "Plinius revidiert die Ausgaben in Byzanz. Er streicht die Kosten f√ºr einen Gesandten, der j√§hrlich nur eine Ehrenadresse nach Rom bringen sollte, um Geld zu sparen.",
    quote: "Als ich in Byzanz die Ausgaben revidierte [...] habe ich es f√ºr richtig gehalten, auf den Gesandten zu verzichten.",
    source: "Plinius, Epist. X, 43"
  },
  {
    id: 9,
    title: "Widerstand der St√§dte",
    location: "Apamea",
    coords: [40.37, 28.88],
    date: "112 n. Chr.",
    text: "In Apamea weigern sich die B√ºrger zun√§chst, ihre B√ºcher offenzulegen, unter Berufung auf alte Privilegien. Plinius fragt Trajan um Rat, wie er verfahren soll.",
    quote: "Herr, als ich mich in Apamea [...] orientieren wollte, bekam ich die Antwort, sie alle w√ºnschten zwar, da√ü ich in ihre Abrechnungen Einblick erhielte, doch habe es noch nie ein Statthalter verlangt.",
    source: "Plinius, Epist. X, 47"
  },
  {
    id: 10,
    title: "Wasser f√ºr Sinope",
    location: "Sinope",
    coords: [42.02, 35.15],
    date: "112/113 n. Chr.",
    text: "Sinope leidet unter Wassermangel. Plinius schl√§gt vor, Wasser aus 16 Meilen Entfernung heranzuf√ºhren, muss aber erst pr√ºfen lassen, ob der Boden das Gewicht des Aqu√§dukts tr√§gt.",
    quote: "Herr, die Sinopenser leiden Mangel an Wasser, aber es scheint gut und reichlich [...] herangef√ºhrt werden zu k√∂nnen.",
    source: "Plinius, Epist. X, 90"
  },
  {
    id: 11,
    title: "Die Christenfrage",
    location: "Amisus / Pontus",
    coords: [41.28, 36.33],
    date: "112/113 n. Chr.",
    text: "Hier (oder in der Region) verfasst Plinius seinen ber√ºhmten Brief √ºber die Christen. Er ist unsicher, wie er mit ihnen verfahren soll, da er 'nichts als einen w√ºsten Aberglauben' fand.",
    quote: "Gerichtsverhandlungen gegen Christen habe ich noch nie beigewohnt; deshalb wei√ü ich nicht, was und wieweit man zu strafen [...] pflegt.",
    source: "Plinius, Epist. X, 96"
  }
];

// --- GEOJSON PLATZHALTER ---
const PLACEHOLDER_GEOJSON = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": { "name": "Bithynia et Pontus (Plinius Provinz)" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [29.0, 40.0], [32.0, 40.0], [36.0, 41.0], [38.0, 41.0], [36.0, 42.0], [30.0, 41.5], [29.0, 41.0], [29.0, 40.0]
        ]]
      }
    }
  ]
};

export default function App() {
  const [activeRoute, setActiveRoute] = useState('marc'); 
  const [currentStep, setCurrentStep] = useState(0);
  const [showBorders, setShowBorders] = useState(true);
  
  const mapContainerRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef([]);
  const geoJsonLayerRef = useRef(null);
  const polylineRef = useRef(null); 

  const activeData = activeRoute === 'marc' ? MARC_AUREL_DATA : PLINIUS_DATA;
  const data = activeData[currentStep];
  const isLast = currentStep === activeData.length - 1;
  const isFirst = currentStep === 0;

  // --- THEME COLORS ---
  const theme = activeRoute === 'marc' ? {
    primary: 'amber',
    primaryHex: '#d97706',
    darkHex: '#78350f',
    lightHex: '#fcd34d',
    gradientFrom: 'from-amber-600',
    gradientTo: 'to-amber-800',
    selectionBg: 'selection:bg-amber-900',
    icon: <Scroll className="text-slate-950 w-6 h-6" />,
    title: "ITER MARCI AURELII",
    subtitle: "Die Reise nach der Usurpation"
  } : {
    primary: 'cyan',
    primaryHex: '#06b6d4',
    darkHex: '#155e75',
    lightHex: '#67e8f9',
    gradientFrom: 'from-cyan-600',
    gradientTo: 'to-cyan-800',
    selectionBg: 'selection:bg-cyan-900',
    icon: <PenTool className="text-slate-950 w-6 h-6" />,
    title: "ITER PLINII",
    subtitle: "Reise in die Provinz Bithynien"
  };

  // --- LEAFLET INITIALIZATION ---
  useEffect(() => {
    // 1. CSS laden (WICHTIG f√ºr Rendering)
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);

    // 2. Fonts laden
    const fontLink = document.createElement('link');
    fontLink.rel = 'stylesheet';
    fontLink.href = 'https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap';
    document.head.appendChild(fontLink);

    // 3. Leaflet JS laden
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.async = true;
    script.onload = () => {
      initMap();
    };
    document.body.appendChild(script);

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  const initMap = () => {
    if (!window.L || !mapContainerRef.current) return;
    if (mapInstanceRef.current) return;

    const L = window.L;

    // Karte erstellen (Mit Attribution und Zoom!)
    const map = L.map(mapContainerRef.current, {
      zoomControl: true, // Aktiviert die +/- Buttons
      attributionControl: true // Zeigt "Leaflet" Link unten rechts
    }).setView([40.0, 25.0], 5);

    mapInstanceRef.current = map;

    // Tile Layer (Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    updateMapContent();
  };

  const updateMapContent = () => {
    if (!mapInstanceRef.current || !window.L) return;
    const L = window.L;
    const map = mapInstanceRef.current;

    // Marker s√§ubern
    markersRef.current.forEach(m => m.remove());
    markersRef.current = [];

    // Polyline s√§ubern
    if (polylineRef.current) {
        polylineRef.current.remove();
        polylineRef.current = null;
    }

    // Neue Marker
    activeData.forEach((stop, index) => {
      const icon = L.divIcon({
        className: 'custom-marker-icon',
        html: `<div id="marker-${index}" style="
          width: 24px;
          height: 24px;
          background-color: ${index === 0 ? theme.primaryHex : '#334155'};
          border: 2px solid ${index === 0 ? '#fff' : '#475569'};
          border-radius: 50%;
          transition: all 0.5s ease;
          box-shadow: 0 0 10px rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-family: 'Lato', sans-serif;
          font-weight: bold;
          font-size: 12px;
        ">${index + 1}</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker(stop.coords, { icon }).addTo(map);
      
      const popupContent = `
        <div style="font-family: 'Cinzel', serif; text-align: center;">
          <strong style="color: ${theme.primaryHex}; font-size: 14px;">${stop.title}</strong><br/>
          <span style="color: #94a3b8; font-size: 11px;">${stop.date}</span>
        </div>
      `;
      
      marker.bindPopup(popupContent, {
        closeButton: false,
        className: 'custom-leaflet-popup' 
      });

      marker.on('click', () => {
        setCurrentStep(index);
      });

      markersRef.current[index] = marker;
    });

    // Verbindungslinie
    const latlngs = activeData.map(d => d.coords);
    const polyline = L.polyline(latlngs, {
        color: theme.primaryHex,
        weight: 2,
        opacity: 0.3,
        dashArray: '5, 10',
        smoothFactor: 1
    }).addTo(map);
    polylineRef.current = polyline;

    // GeoJSON
    if (geoJsonLayerRef.current) geoJsonLayerRef.current.remove();
    
    const borderStyle = {
      color: theme.primaryHex,
      weight: 1.5,
      opacity: 0.8,
      fillColor: theme.primaryHex,
      fillOpacity: 0.05,
      dashArray: '5, 8',
      lineCap: 'round'
    };

    const geoJsonLayer = L.geoJSON(PLACEHOLDER_GEOJSON, {
      style: borderStyle,
      onEachFeature: (feature, layer) => {
        if (feature.properties && feature.properties.name) {
          layer.bindTooltip(feature.properties.name, {
            permanent: false,
            direction: 'center',
            className: 'custom-leaflet-tooltip' 
          });
        }
      }
    });
    
    geoJsonLayerRef.current = geoJsonLayer;
    if (showBorders) geoJsonLayer.addTo(map);

    // CSS Update f√ºr Popups und Tooltips
    const styleId = 'leaflet-custom-styles';
    let styleEl = document.getElementById(styleId);
    if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = styleId;
        document.head.appendChild(styleEl);
    }
    
    styleEl.innerHTML = `
      .leaflet-popup-content-wrapper {
        background: #0f172a;
        border: 1px solid ${theme.darkHex};
        border-radius: 4px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.8);
      }
      .leaflet-popup-tip {
        background: #0f172a;
        border-left: 1px solid ${theme.darkHex};
        border-top: 1px solid ${theme.darkHex};
      }
      .leaflet-container {
        background: #020617;
      }
      .custom-leaflet-tooltip {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid ${theme.primaryHex};
        color: ${theme.lightHex};
        font-family: 'Cinzel', serif;
        font-size: 10px;
        border-radius: 2px;
        box-shadow: none;
      }
      .leaflet-tooltip-left::before { border-left-color: ${theme.primaryHex}; }
      .leaflet-tooltip-right::before { border-right-color: ${theme.primaryHex}; }
    `;

    map.flyTo(activeData[0].coords, 6, {
        animate: true,
        duration: 1.5
    });
    
    setCurrentStep(0);
  };

  useEffect(() => {
    updateMapContent();
  }, [activeRoute]);

  useEffect(() => {
      if (!mapInstanceRef.current || !geoJsonLayerRef.current) return;
      if (showBorders) {
          geoJsonLayerRef.current.addTo(mapInstanceRef.current);
      } else {
          geoJsonLayerRef.current.remove();
      }
  }, [showBorders]);

  useEffect(() => {
    if (!mapInstanceRef.current || !window.L) return;
    const map = mapInstanceRef.current;
    
    map.flyTo(activeData[currentStep].coords, 6, {
      animate: true,
      duration: 2.0,
      easeLinearity: 0.25
    });

    activeData.forEach((_, index) => {
      const markerEl = document.getElementById(`marker-${index}`);
      if (markerEl && markersRef.current[index]) {
        if (index === currentStep) {
          markerEl.style.backgroundColor = theme.primaryHex;
          markerEl.style.borderColor = '#ffffff';
          markerEl.style.transform = 'scale(1.5)';
          markerEl.style.boxShadow = `0 0 15px ${theme.primaryHex}`;
          markerEl.style.zIndex = '1000';
          markersRef.current[index].openPopup();
        } else if (index < currentStep) {
          markerEl.style.backgroundColor = theme.darkHex;
          markerEl.style.borderColor = '#000';
          markerEl.style.transform = 'scale(1.0)';
          markerEl.style.boxShadow = 'none';
          markersRef.current[index].closePopup();
        } else {
          markerEl.style.backgroundColor = '#1e293b';
          markerEl.style.borderColor = '#334155';
          markerEl.style.transform = 'scale(0.8)';
          markerEl.style.boxShadow = 'none';
          markersRef.current[index].closePopup();
        }
      }
    });
  }, [currentStep, activeData, theme]);

  const handleNext = () => { if (!isLast) setCurrentStep(prev => prev + 1); };
  const handlePrev = () => { if (!isFirst) setCurrentStep(prev => prev - 1); };

  return (
    <div className={`flex flex-col h-screen bg-slate-950 text-slate-200 overflow-hidden font-sans ${theme.selectionBg}`}>
      
      {/* HEADER */}
      <header className="flex-none z-20 bg-slate-950/90 border-b border-white/10 backdrop-blur-md px-6 py-4 flex flex-col md:flex-row items-center justify-between shadow-2xl gap-4">
        
        {/* Title Area */}
        <div className="flex items-center gap-4 w-full md:w-auto">
          <motion.div 
            key={activeRoute}
            initial={{ rotate: -90, opacity: 0 }}
            animate={{ rotate: 0, opacity: 1 }}
            className={`bg-gradient-to-br ${theme.gradientFrom} ${theme.gradientTo} p-2 rounded shadow-lg shadow-black/50`}
          >
            {theme.icon}
          </motion.div>
          <div>
            <motion.h1 
              key={theme.title}
              initial={{ y: -10, opacity: 0 }}
              animate={{ y: 0, opacity: 1 }}
              className={`text-xl md:text-2xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r ${activeRoute === 'marc' ? 'from-amber-200 to-amber-500' : 'from-cyan-200 to-cyan-500'}`} 
              style={{ fontFamily: '"Cinzel", serif' }}
            >
              {theme.title}
            </motion.h1>
            <p className="text-xs text-slate-500 uppercase tracking-[0.2em]">{theme.subtitle}</p>
          </div>
        </div>
        
        {/* Controls Area */}
        <div className="flex items-center gap-4">
            
            {/* Route Switcher */}
            <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-800">
                <button
                    onClick={() => setActiveRoute('marc')}
                    className={`px-4 py-2 rounded text-xs uppercase tracking-wider font-bold transition-all ${activeRoute === 'marc' ? 'bg-amber-700 text-white shadow-lg' : 'text-slate-500 hover:text-amber-500'}`}
                >
                    Marc Aurel
                </button>
                <button
                    onClick={() => setActiveRoute('plinius')}
                    className={`px-4 py-2 rounded text-xs uppercase tracking-wider font-bold transition-all ${activeRoute === 'plinius' ? 'bg-cyan-700 text-white shadow-lg' : 'text-slate-500 hover:text-cyan-500'}`}
                >
                    Plinius
                </button>
            </div>

            {/* Toggle Borders */}
            <button 
                onClick={() => setShowBorders(!showBorders)}
                className={`hidden md:flex items-center gap-2 px-3 py-2 rounded text-xs uppercase tracking-wider transition-colors border ${showBorders ? `bg-slate-800 border-${theme.primary}-700 text-${theme.primary}-500` : 'bg-slate-900 border-slate-700 text-slate-500'}`}
                style={{ borderColor: showBorders ? theme.darkHex : '', color: showBorders ? theme.lightHex : '' }}
            >
                <Layers size={14} />
            </button>
        </div>
      </header>

      {/* MAIN CONTENT SPLIT */}
      <div className="flex-1 flex flex-col md:flex-row relative">
        
        {/* LEFT PANEL: NARRATIVE */}
        <div className={`w-full md:w-[450px] flex-none relative z-10 bg-slate-900/95 border-r flex flex-col shadow-2xl h-1/2 md:h-auto order-2 md:order-1 transition-colors duration-500`} style={{ borderColor: `${theme.darkHex}40` }}> 
          
          {/* Progress Bar */}
          <div className="h-1 w-full bg-slate-800">
            <motion.div 
              className="h-full shadow-[0_0_10px_currentColor]"
              style={{ backgroundColor: theme.primaryHex, color: theme.primaryHex }}
              initial={{ width: 0 }}
              animate={{ width: `${((currentStep + 1) / activeData.length) * 100}%` }}
              transition={{ duration: 0.5 }}
            />
          </div>

          <div className="flex-1 overflow-y-auto p-6 md:p-8 custom-scrollbar">
            <AnimatePresence mode="wait">
              <motion.div
                key={`${activeRoute}-${data.id}`}
                initial={{ opacity: 0, x: -20, filter: 'blur(5px)' }}
                animate={{ opacity: 1, x: 0, filter: 'blur(0px)' }}
                exit={{ opacity: 0, x: 20, filter: 'blur(5px)' }}
                transition={{ duration: 0.5, ease: "circOut" }}
                className="space-y-6"
              >
                {/* Meta Info */}
                <div className="flex items-center gap-3 text-sm font-bold tracking-widest uppercase transition-colors" style={{ color: theme.lightHex }}>
                  <span className="flex items-center gap-1"><MapPin size={14} /> Station {data.id}/{activeData.length}</span>
                  <span className="w-1 h-1 rounded-full bg-slate-600"></span>
                  <span>{data.date}</span>
                </div>

                {/* Title */}
                <h2 className="text-3xl md:text-3xl text-slate-100 leading-tight" style={{ fontFamily: '"Cinzel", serif' }}>
                  {data.title}
                </h2>

                {/* Location */}
                <div className="inline-block px-3 py-1 bg-slate-800/50 rounded text-slate-400 text-sm border border-slate-700/50">
                  üìç {data.location}
                </div>

                {/* Main Text */}
                <p className="text-base md:text-lg text-slate-300 leading-relaxed font-light" style={{ fontFamily: '"Lato", sans-serif' }}>
                  {data.text}
                </p>

                {/* Quote Block */}
                <div className="relative mt-8 p-6 bg-slate-950 rounded-lg border group transition-colors duration-500" style={{ borderColor: `${theme.darkHex}80` }}>
                  <div className="absolute -top-3 left-4 bg-slate-900 px-2" style={{ color: theme.primaryHex }}>
                    <BookOpen size={20} />
                  </div>
                  <blockquote className="italic text-slate-400 font-serif text-base leading-relaxed">
                    "{data.quote}"
                  </blockquote>
                  <div className="mt-4 text-right text-xs font-bold uppercase tracking-wider" style={{ color: theme.darkHex }}>
                    ‚Äî {data.source}
                  </div>
                </div>

              </motion.div>
            </AnimatePresence>
          </div>

          {/* Controls */}
          <div className="p-4 md:p-6 bg-slate-950 border-t border-slate-800 flex gap-4 mt-auto">
            <button
              onClick={handlePrev}
              disabled={isFirst}
              className={`flex-1 py-3 md:py-4 px-4 rounded flex items-center justify-center gap-2 transition-all duration-300 font-serif tracking-widest uppercase text-xs md:text-sm
                ${isFirst 
                  ? 'opacity-30 cursor-not-allowed text-slate-500' 
                  : `hover:bg-slate-800 border border-slate-700`
                }`}
              style={{ 
                  borderColor: isFirst ? '' : theme.darkHex, 
                  color: isFirst ? '' : theme.lightHex 
              }}
            >
              <ChevronLeft size={16} /> <span className="hidden md:inline">Zur√ºck</span>
            </button>
            <button
              onClick={handleNext}
              disabled={isLast}
              className={`flex-1 py-3 md:py-4 px-4 rounded flex items-center justify-center gap-2 transition-all duration-300 font-serif tracking-widest uppercase text-xs md:text-sm
                ${isLast
                  ? 'bg-slate-800 text-slate-500 cursor-not-allowed'
                  : 'text-slate-950 font-bold shadow-lg'
                }`}
              style={{ 
                  backgroundColor: isLast ? '' : theme.primaryHex,
                  boxShadow: isLast ? '' : `0 0 20px ${theme.darkHex}`
              }}
            >
              {isLast ? 'Ende' : 'Weiter'} <ChevronRight size={16} />
            </button>
          </div>
        </div>

        {/* RIGHT PANEL: MAP */}
        <div className="flex-1 relative bg-slate-900 z-0 h-1/2 md:h-auto order-1 md:order-2">
          <div id="map" ref={mapContainerRef} className="w-full h-full bg-[#020617]"></div>

          {/* Vignette */}
          <div className="absolute inset-0 z-[401] pointer-events-none bg-[radial-gradient(circle_at_center,transparent_0%,rgba(2,6,23,0.4)_100%)] shadow-[inset_0_0_50px_rgba(0,0,0,0.8)]"></div>
        </div>

      </div>
    </div>
  );
}
